{% extends "base.html" %}
{% block title %}{{ t('personal_title', default='Personal Dashboard') }}{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
.personal-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    border: none;
    border-radius: 12px;
}
.personal-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}
.personal-amount-value {
    font-size: 1.5rem;
    font-weight: bold;
}
.personal-status-indicator {
    font-size: 0.9rem;
}
.recent-activity-item {
    border-left: 4px solid #007bff;
    padding-left: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}
.recent-activity-item:hover {
    background-color: rgba(0,123,255,0.05);
    border-radius: 8px;
    padding: 10px 15px;
    margin-left: -10px;
}
.personal-recent-activity-item {
    border-left: 4px solid #007bff;
    padding-left: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}
.personal-recent-activity-item:hover {
    background-color: rgba(0,123,255,0.05);
    border-radius: 8px;
    padding: 10px 15px;
    margin-left: -10px;
}
.personal-activity-icon-wrapper {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
}
.personal-activity-content-placeholder {
    flex-grow: 1;
}
.personal-no-activity {
    opacity: 0.7;
}
.animate-click {
    transform: scale(0.98);
    transition: transform 0.1s ease-in-out;
}
.text-budget { color: #007bff; }
.text-bill { color: #ffc107; }
.text-shopping { color: #17a2b8; }
.text-credits { color: #28a745; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-1">{{ t('personal_welcome', default='Welcome') }} {{ current_user.name if current_user.is_authenticated else t('personal_guest', default='Guest') }}</h2>
            <p class="text-muted mb-4">{{ t('personal_subtitle', default='Your financial overview at a glance') }}</p>
        </div>
    </div>

    {% if current_user.is_authenticated %}
    <!-- Financial Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card personal-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">{{ t('budget_status', default='Budget Status') }}</h6>
                        <i class="bi bi-pie-chart-fill text-primary"></i>
                    </div>
                    <div class="personal-amount-value" id="budgetStatus" data-amount="0">****</div>
                    <small class="personal-status-indicator text-muted">{{ t('loading', default='Loading...') }}</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card personal-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">{{ t('upcoming_bills', default='Upcoming Bills') }}</h6>
                        <i class="bi bi-receipt text-warning"></i>
                    </div>
                    <div class="personal-amount-value" id="upcomingBills" data-amount="0">****</div>
                    <small class="personal-status-indicator text-muted">{{ t('loading', default='Loading...') }}</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card personal-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">{{ t('shopping_spending', default='Shopping Spending') }}</h6>
                        <i class="bi bi-cart text-info"></i>
                    </div>
                    <div class="personal-amount-value" id="shoppingSpending" data-amount="0">****</div>
                    <small class="personal-status-indicator text-muted">{{ t('loading', default='Loading...') }}</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card personal-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">{{ t('wallet_balance', default='Wallet Balance') }}</h6>
                        <i class="bi bi-wallet2 text-success"></i>
                    </div>
                    <div class="personal-amount-value" id="walletBalance" data-amount="0">****</div>
                    <small class="text-muted">{{ t('ficore_credits', default='FiCore Credits') }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity and Quick Actions -->
    <div class="row g-4">
        <!-- Recent Activity -->
        <div class="col-lg-8">
            <div class="card personal-card h-100">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>{{ t('recent_activity', default='Recent Activity') }}
                    </h5>
                    <a href="#" id="viewAllActivities" class="btn btn-sm btn-outline-primary" onclick="toggleRecentActivities()">{{ t('view_all', default='View All') }}</a>
                </div>
                <div class="card-body">
                    <div id="recentActivityListLimited"></div>
                    <div id="recentActivityListFull" class="d-none"></div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="col-lg-4">
            <div class="card personal-card h-100">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning-charge me-2"></i>{{ t('quick_actions', default='Quick Actions') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <a href="{{ url_for('budget.index') }}" class="btn btn-outline-primary w-100 btn-sm personal-quick-action-item">
                                <i class="bi bi-pie-chart d-block mb-1"></i>
                                <small>{{ t('budget_title', default='Budget') }}</small>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('bill.index') }}" class="btn btn-outline-warning w-100 btn-sm personal-quick-action-item">
                                <i class="bi bi-receipt d-block mb-1"></i>
                                <small>{{ t('bill_title', default='Bills') }}</small>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('shopping.index') }}" class="btn btn-outline-info w-100 btn-sm personal-quick-action-item">
                                <i class="bi bi-cart d-block mb-1"></i>
                                <small>{{ t('shopping_title', default='Shopping') }}</small>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('reports.index') }}" class="btn btn-outline-success w-100 btn-sm personal-quick-action-item">
                                <i class="bi bi-graph-up d-block mb-1"></i>
                                <small>{{ t('reports_title', default='Reports') }}</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Services -->
    <div class="row g-4 mt-2">
        <div class="col-12">
            <h5 class="mb-3">{{ t('available_services', default='Available Services') }}</h5>
            <div class="row g-3">
                <div class="col-lg-3 col-md-6">
                    <a href="{{ url_for('budget.index') }}" class="card personal-card personal-service-grid-item h-100 text-decoration-none">
                        <div class="card-body text-center">
                            <i class="bi bi-pie-chart-fill text-budget fa-2x mb-2"></i>
                            <h6 class="mb-0">{{ t('budget_title', default='Budget') }}</h6>
                            <p class="text-muted small mb-0">{{ t('budget_description', default='Plan and track your income and expenses') }}</p>
                        </div>
                    </a>
                </div>
                <div class="col-lg-3 col-md-6">
                    <a href="{{ url_for('bill.index') }}" class="card personal-card personal-service-grid-item h-100 text-decoration-none">
                        <div class="card-body text-center">
                            <i class="bi bi-receipt-cutoff text-bill fa-2x mb-2"></i>
                            <h6 class="mb-0">{{ t('bill_title', default='Bills') }}</h6>
                            <p class="text-muted small mb-0">{{ t('bill_description', default='Manage and pay your bills on time') }}</p>
                        </div>
                    </a>
                </div>
                <div class="col-lg-3 col-md-6">
                    <a href="{{ url_for('shopping.index') }}" class="card personal-card personal-service-grid-item h-100 text-decoration-none">
                        <div class="card-body text-center">
                            <i class="bi bi-cart-fill text-shopping fa-2x mb-2"></i>
                            <h6 class="mb-0">{{ t('shopping_title', default='Shopping') }}</h6>
                            <p class="text-muted small mb-0">{{ t('shopping_description', default='Create and track shopping lists') }}</p>
                        </div>
                    </a>
                </div>
                <div class="col-lg-3 col-md-6">
                    <a href="{{ url_for('credits.request_credits') }}" class="card personal-card personal-service-grid-item h-100 text-decoration-none">
                        <div class="card-body text-center">
                            <i class="bi bi-wallet2 text-credits fa-2x mb-2"></i>
                            <h6 class="mb-0">{{ t('credits_title', default='FiCore Credits') }}</h6>
                            <p class="text-muted small mb-0">{{ t('credits_description', default='Manage your credits and transactions') }}</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Guest View -->
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card personal-card text-center py-5">
                <div class="card-body">
                    <i class="bi bi-speedometer2 fa-4x text-primary mb-4"></i>
                    <h3 class="mb-3">{{ t('welcome_ficore', default='Welcome to FiCore') }}</h3>
                    <p class="text-muted mb-4">{{ t('please_login', default='Please log in to view your personalized financial dashboard.') }}</p>
                    <a href="{{ url_for('users.login') }}" class="btn btn-primary btn-lg">
                        <i class="bi bi-box-arrow-in-right me-2"></i>{{ t('general_login', default='Log In') }}
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Initialize tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

    // Check Bootstrap Icons
    document.querySelectorAll('.bi').forEach(icon => {
        if (!icon.className.includes('bi-')) {
            console.warn('Invalid or missing Bootstrap Icon class:', icon.className);
        }
    });

    // Load financial summary and recent activity for authenticated users
    {% if current_user.is_authenticated %}
    loadFinancialSummary();
    refreshRecentActivity();

    // Auto-refresh recent activity every 5 minutes
    setInterval(refreshRecentActivity, 300000);

    // Add click animation for quick actions and service cards
    document.querySelectorAll('.personal-quick-action-item, .personal-service-grid-item').forEach(card => {
        card.addEventListener('click', () => {
            card.classList.add('animate-click');
            setTimeout(() => {
                card.classList.remove('animate-click');
            }, 200);
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        });
    });
    {% endif %}
});

let amountsVisible = true;
let isActivityExpanded = false;

function formatCurrency(value) {
    if (value === null || value === undefined) return '0.00';
    value = parseFloat(value);
    if (isNaN(value)) return '0.00';
    return value.toLocaleString('en-NG', { style: 'currency', currency: 'NGN', minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatTimeAgo(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diff = now - time;
    const minutes = Math.floor(diff / 60000);
    if (minutes < 1) return window.t('just_now', { default: 'Yanzu' });
    if (minutes < 60) return minutes + " " + window.t('minutes_ago', { default: 'mintuna da suka wuce' });
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + " " + window.t('hours_ago', { default: 'awanni da suka wuce' });
    const days = Math.floor(hours / 24);
    return days + " " + window.t('days_ago', { default: 'kwanaki da suka wuce' });
}

function toggleAmountVisibility() {
    amountsVisible = !amountsVisible;
    const visibilityIcon = document.getElementById('visibilityIcon');
    visibilityIcon.classList.toggle('bi-eye', amountsVisible);
    visibilityIcon.classList.toggle('bi-eye-slash', !amountsVisible);
    
    if (amountsVisible) {
        visibilityIcon.style.color = '#28a745';
        visibilityIcon.style.transform = 'scale(1.1)';
    } else {
        visibilityIcon.style.color = '#dc3545';
        visibilityIcon.style.transform = 'scale(1)';
    }
    
    document.querySelectorAll('.personal-amount-value').forEach(el => {
        el.textContent = amountsVisible ? formatCurrency(el.dataset.amount) : '****';
    });
}

function refreshRecentActivity() {
    const limitedList = document.getElementById('recentActivityListLimited');
    const fullList = document.getElementById('recentActivityListFull');
    
    limitedList.innerHTML = `
        <div class="personal-recent-activity-item">
            <div class="personal-activity-content-placeholder">
                <div class="personal-activity-description fw-semibold">${window.t('loading', { default: 'Ana loda...' })}</div>
            </div>
        </div>
    `;
    fullList.innerHTML = limitedList.innerHTML;

    fetch('{{ url_for("dashboard.api_recent_activity") }}')
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.recent_transactions && data.recent_transactions.length > 0) {
                updateRecentActivityDisplay(data.recent_transactions);
            } else {
                const noActivityHtml = `
                    <div class="personal-recent-activity-item personal-no-activity">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-info-circle text-muted me-2"></i>
                                    <strong>${window.t('no_recent_activity', { default: 'Babu ayyukan kwanan nan' })}</strong>
                                </div>
                                <small class="text-muted">${window.t('start_activity_detailed', { default: 'Fara da ƙara kasafin kuɗi, biya kuɗin da ke jiran biya, ko sayen kayan da kuke buƙata don ganin ayyukanku' })}</small>
                            </div>
                        </div>
                    </div>
                `;
                limitedList.innerHTML = noActivityHtml;
                fullList.innerHTML = noActivityHtml;
            }
        })
        .catch(error => {
            console.error('Error loading recent activity:', error);
            const errorMessage = error.message.includes('NetworkError') || error.message.includes('Failed to fetch')
                ? window.t('network_error', { default: 'Kuskuren sadarwa' })
                : window.t('error_loading_activities', { default: 'Kuskure wajen loda ayyukan' });
            const errorHtml = `
                <div class="personal-recent-activity-item personal-no-activity">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                <strong>${errorMessage}</strong>
                            </div>
                            <small class="text-muted">${window.t('try_again_later', { default: 'Sake gwadawa daga baya' })}</small>
                        </div>
                    </div>
                </div>
            `;
            limitedList.innerHTML = errorHtml;
            fullList.innerHTML = errorHtml;
        });
}

function updateRecentActivityDisplay(transactions) {
    const limitedList = document.getElementById('recentActivityListLimited');
    const fullList = document.getElementById('recentActivityListFull');
    
    const renderTransaction = (transaction) => {
        const isIncome = transaction.type === 'income';
        const icon = isIncome ? 'bi-arrow-up-circle text-success' : 'bi-arrow-down-circle text-danger';
        const amountClass = isIncome ? 'text-success' : 'text-danger';
        const amountPrefix = isIncome ? '+' : '-';
        
        return `
            <div class="personal-recent-activity-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <i class="bi ${icon} me-2"></i>
                            <strong>${transaction.description}</strong>
                            <span class="badge bg-secondary ms-2">${transaction.category}</span>
                        </div>
                        <small class="text-muted">${transaction.formatted_date}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold ${amountClass}">
                            ${amountPrefix}${transaction.formatted_amount}
                        </div>
                        <small class="text-muted">${transaction.status.charAt(0).toUpperCase() + transaction.status.slice(1)}</small>
                    </div>
                </div>
            </div>
        `;
    };

    limitedList.innerHTML = transactions.slice(0, 3).map(renderTransaction).join('');
    fullList.innerHTML = transactions.map(renderTransaction).join('');
}

function toggleRecentActivities() {
    const limitedList = document.getElementById('recentActivityListLimited');
    const fullList = document.getElementById('recentActivityListFull');
    const viewAllButton = document.getElementById('viewAllActivities');
    
    isActivityExpanded = !isActivityExpanded;
    limitedList.classList.toggle('d-none', isActivityExpanded);
    fullList.classList.toggle('d-none', !isActivityExpanded);
    viewAllButton.textContent = isActivityExpanded ? window.t('view_less', { default: 'Duba Ƙasa' }) : window.t('view_all', { default: 'Duba Duk' });
}

function loadFinancialSummary() {
    fetch('/summaries/budget/summary')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Budget summary error:', data.error);
                return;
            }
            const budgetStatus = document.getElementById('budgetStatus');
            if (budgetStatus) {
                budgetStatus.querySelector('.personal-amount-value').dataset.amount = data.totalBudget;
                budgetStatus.querySelector('.personal-amount-value').textContent = amountsVisible ? formatCurrency(data.totalBudget) : '****';
                budgetStatus.querySelector('.personal-status-indicator').textContent = data.totalBudget >= 0 ? window.t('on_track', { default: 'A Kan Hanya' }) : window.t('over_budget', { default: 'Fiye da Kasafin Kuɗi' });
            }
        })
        .catch(error => {
            console.error('Error loading budget summary:', error);
        });

    fetch('/summaries/bill/summary')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Bill summary error:', data.error);
                return;
            }
            const upcomingBills = document.getElementById('upcomingBills');
            if (upcomingBills) {
                upcomingBills.querySelector('.personal-amount-value').dataset.amount = data.pending_amount;
                upcomingBills.querySelector('.personal-amount-value').textContent = amountsVisible ? formatCurrency(data.pending_amount) : '****';
                upcomingBills.querySelector('.personal-status-indicator').textContent = data.overdue_amount > 0 ? window.t('overdue', { default: 'Ya Wuce Lokaci' }) : window.t('on_time', { default: 'A Kan Lokaci' });
            }
        })
        .catch(error => {
            console.error('Error loading bill summary:', error);
        });

    fetch('/summaries/shopping/summary')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Shopping summary error:', data.error);
                return;
            }
            const shoppingSpending = document.getElementById('shoppingSpending');
            if (shoppingSpending) {
                shoppingSpending.querySelector('.personal-amount-value').dataset.amount = data.total_shopping_spent;
                shoppingSpending.querySelector('.personal-amount-value').textContent = amountsVisible ? formatCurrency(data.total_shopping_spent) : '****';
                shoppingSpending.querySelector('.personal-status-indicator').textContent = data.total_shopping_spent <= data.total_shopping_budget ? window.t('within_budget', { default: 'Cikin Kasafin Kuɗi' }) : window.t('over_budget', { default: 'Fiye da Kasafin Kuɗi' });
            }
        })
        .catch(error => {
            console.error('Error loading shopping summary:', error);
        });

    fetch('/summaries/ficore_balance')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Ficore balance error:', data.error);
                return;
            }
            const walletBalanceElement = document.getElementById('walletBalance');
            if (walletBalanceElement) {
                walletBalanceElement.dataset.amount = data.balance;
                walletBalanceElement.textContent = amountsVisible ? formatCurrency(data.balance) : '****';
            }
        })
        .catch(error => {
            console.error('Error loading ficore balance:', error);
        });
}
</script>
{% endblock %}
